---
import { actions } from "astro:actions";

import SidebarUserAvatar from "./SidebarUserAvatar.astro";

interface Props {
	user: NonNullable<App.Locals["user"]>;
}

const { user } = Astro.props;

const { displayUsername, email, image } = user;
const avatar = image
	? { value: image, placeholder: false }
	: {
			value: (displayUsername ?? email)?.slice(0, 2).toUpperCase(),
			placeholder: true,
		};
---

<div
	style="anchor-name: --anchor-popover-user;"
	class="is-drawer-open:px-4 is-drawer-open:py-2 grid w-full py-4"
>
	<button
		popovertarget="popover-user"
		class="is-drawer-close:justify-center is-drawer-close:tooltip is-drawer-close:tooltip-right is-drawer-close:btn-circle is-drawer-close:mx-auto btn btn-outline is-drawer-open:px-2 is-drawer-open:sm:px-4 is-drawer-open:py-8 is-drawer-open:rounded-lg flex items-center gap-2"
		data-tip="User"
	>
		<SidebarUserAvatar {...avatar} class="w-10 rounded-full" />
		<div
			class="is-drawer-close:hidden flex flex-1 flex-col space-y-1 text-start font-normal"
		>
			<p class="max-w-32 overflow-clip text-ellipsis">
				{user?.displayUsername}
			</p>
			<span class="badge badge-xs badge-primary font-medium uppercase"
				>role:{user?.role}</span
			>
		</div>

		<iconify-icon
			icon="lucide:ellipsis-vertical"
			width="20"
			class="is-drawer-close:hidden"></iconify-icon>
	</button>
	<ul
		class="dropdown is-drawer-open:dropdown-end menu rounded-box bg-base-100 is-drawer-open:ml-0 is-drawer-open:mr-4 ml-2 w-36 text-xs shadow-sm"
		id="popover-user"
		style="position-anchor:--anchor-popover-user"
		popover
	>
		<li class="menu-title pointer-events-none flex-row items-center gap-1.5">
			<SidebarUserAvatar {...avatar} class="w-6" />

			<span
				class="text-base-content max-w-18 overflow-clip text-xs text-ellipsis"
				>{user?.name}</span
			>
		</li>
		<div class="divider -my-1.5"></div>

		<li><button>Edit profil</button></li>
		<li><button>Ubah password</button></li>

		<div class="divider -mt-1 mb-0"></div>

		<form method="post" action={actions.auth.logout} class="contents">
			<li class="font-medium">
				<button type="submit" class="text-error-content bg-error">
					<iconify-icon icon="lucide:log-out"></iconify-icon>
					Keluar
				</button>
			</li>
		</form>
	</ul>
</div>
